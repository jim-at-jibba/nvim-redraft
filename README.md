# nvim-redraft

A Neovim plugin for AI-powered inline code editing using MorphLLM Fast Apply and GPT-4o-mini.

## How It Works

This plugin uses a two-step approach for optimal code editing:

1. **Edit Generation (GPT-4o-mini)**: Generates a sparse edit showing only the changes needed, using `// ... existing code ...` markers to represent unchanged sections
2. **Fast Apply (MorphLLM)**: Merges the sparse edit back into your original code with high accuracy

This approach is faster and more reliable than full file rewrites, handling large selections efficiently while maintaining precision.

## Features

- Select code in visual mode and apply AI edits inline
- No confirmation dialogs - seamless editing experience
- Customizable system prompts
- Configurable keybindings
- Built with Lua and TypeScript for optimal performance

## Installation

### Prerequisites

- Neovim >= 0.8.0
- Node.js >= 18.0.0
- MorphLLM API key ([get one here](https://morphllm.com))
- OpenAI API key ([get one here](https://platform.openai.com/api-keys))

### Using [lazy.nvim](https://github.com/folke/lazy.nvim)

```lua
{
  "yourusername/nvim-redraft",
  config = function()
    require("nvim-redraft").setup({
      -- Optional configuration
      system_prompt = "You are a code editing assistant...",
      keybindings = {
        visual_edit = "<leader>ae",
      },
    })
  end,
  build = "cd ts && npm install && npm run build",
}
```

### Using [packer.nvim](https://github.com/wbthomason/packer.nvim)

```lua
use {
  "yourusername/nvim-redraft",
  config = function()
    require("nvim-redraft").setup()
  end,
  run = "cd ts && npm install && npm run build",
}
```

## Setup

1. Set your API keys:

```bash
export MORPH_API_KEY="your-morph-api-key-here"
export OPENAI_API_KEY="your-openai-api-key-here"
```

2. Install TypeScript dependencies:

```bash
cd ts
npm install
npm run build
```

3. Configure the plugin in your Neovim config:

```lua
require("nvim-redraft").setup({
  system_prompt = "You are a code editing assistant. Apply the requested changes to the code and return only the modified code without explanations.",
  keybindings = {
    visual_edit = "<leader>ae",
  },
  llm = {
    model = "morph-v3-large",
    timeout = 30000,
  },
})
```

## Usage

1. Select code in visual mode (`v`, `V`, or `Ctrl-v`)
2. Press `<leader>ae` (or your configured keybinding)
3. Enter your editing instruction in the prompt
4. The AI will apply the changes inline

### Example

Select this code:

```javascript
function add(a, b) {
  return a + b
}
```

Press `<leader>ae` and type: "add JSDoc comments"

Result:

```javascript
/**
 * Adds two numbers together
 * @param {number} a - First number
 * @param {number} b - Second number
 * @returns {number} Sum of a and b
 */
function add(a, b) {
  return a + b
}
```

## Configuration

### Options

```lua
{
  system_prompt = string,      -- Custom system prompt for the LLM
  keybindings = {
    visual_edit = string,      -- Keybinding for visual mode edit (default: "<leader>ae")
  },
  llm = {
    model = string,            -- LLM model name (default: "morph-v3-large")
    timeout = number,          -- Request timeout in milliseconds (default: 30000)
  },
  debug = boolean,             -- Enable debug logging (default: false)
  log_file = string,           -- Log file path (default: "~/.local/state/nvim/nvim-redraft.log")
  debug_max_log_size = number, -- Max chars to log for code content (default: 5000, 0 = unlimited)
}
```

### Debug Logging

Enable detailed logging to troubleshoot issues:

```lua
require("nvim-redraft").setup({
  debug = true,  -- Enable debug logging
})
```

When enabled, all plugin activity is logged to `~/.local/state/nvim/nvim-redraft.log`, including:
- User instructions and selected code
- Sparse edits generated by GPT-4o-mini
- API requests/responses and timing
- Code transformations and replacements
- All errors with stack traces

**Warning:** Log files contain full code content. Store them securely and delete when done debugging.

### Custom Keybindings

```lua
require("nvim-redraft").setup({
  keybindings = {
    visual_edit = "<C-a>",  -- Use Ctrl+a instead
  },
})
```

To disable the default keybinding:

```lua
require("nvim-redraft").setup({
  keybindings = {
    visual_edit = false,
  },
})
```

You can then create your own:

```lua
vim.keymap.set("v", "<C-a>", function()
  require("nvim-redraft").edit()
end)
```

## Commands

- `:RedraftEdit` - Trigger AI edit on visual selection

## Environment Variables

- `MORPH_API_KEY` - **Required**. Your MorphLLM API key for Fast Apply (merges edits into code)
- `OPENAI_API_KEY` - **Required**. Your OpenAI API key for edit generation (creates sparse edits)

**Why two API keys?** The plugin uses a two-step process: GPT-4o-mini generates sparse edits with change markers, then MorphLLM's Fast Apply model merges them accurately into your code. This is more efficient and reliable than having one model rewrite entire files.

## Troubleshooting

### Enable Debug Logging

For any issues, enable debug logging first:

```lua
require("nvim-redraft").setup({
  debug = true,
})
```

Then check the log file at `~/.local/state/nvim/nvim-redraft.log` for detailed information about what's happening.

### "MORPH_API_KEY not set" or "OPENAI_API_KEY not set" error

Make sure you've exported both API keys in your shell:

```bash
export MORPH_API_KEY="your-morph-api-key"
export OPENAI_API_KEY="your-openai-api-key"
```

Add them to your `.bashrc`, `.zshrc`, or `.profile` to persist across sessions.

### TypeScript service fails to start

Ensure you've built the TypeScript service:

```bash
cd ts
npm install
npm run build
```

Verify that `ts/dist/index.js` exists.

Check debug logs for detailed error messages.

### "Failed to start TypeScript service"

Check that Node.js is installed and in your PATH:

```bash
node --version  # Should be >= 18.0.0
```

Enable debug mode and check `~/.local/state/nvim/nvim-redraft.log` for service startup errors.

### Large selections timeout

For very large code selections, increase the timeout:

```lua
require("nvim-redraft").setup({
  llm = {
    timeout = 60000,  -- 60 seconds
  },
})
```

### Edits not applying correctly

Enable debug logging to see the full transformation:

```lua
require("nvim-redraft").setup({
  debug = true,
})
```

The log will show:
- Original selected code
- Sparse edit generated
- Final merged code
- Any errors in the transformation

### Finding the log file

Default location: `~/.local/state/nvim/nvim-redraft.log`

Custom location:
```lua
require("nvim-redraft").setup({
  debug = true,
  log_file = "/path/to/your/debug.log",
})
```

## Development

### Running Tests

```bash
make test
```

### Formatting

```bash
stylua lua/
```

### Building TypeScript

```bash
cd ts
npm run build
```

## License

MIT
