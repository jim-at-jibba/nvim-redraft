# debug-logging Specification

## Purpose
TBD - created by archiving change add-debug-logging. Update Purpose after archive.
## Requirements
### Requirement: Debug Configuration
The plugin SHALL provide a `debug` configuration option that enables comprehensive logging to a file.

#### Scenario: User enables debug mode
- **WHEN** user sets `debug = true` in plugin setup
- **THEN** all debug logs are written to the configured log file
- **AND** the log file path defaults to `~/.local/state/nvim/nvim-redraft.log`

#### Scenario: User specifies custom log file path
- **WHEN** user sets `log_file = "/custom/path/debug.log"` in plugin setup
- **THEN** all logs are written to the specified path
- **AND** the directory is created if it doesn't exist

#### Scenario: Debug mode is disabled by default
- **WHEN** user does not specify `debug` in plugin setup
- **THEN** no debug logs are written to file
- **AND** there is no performance impact from logging infrastructure

### Requirement: Lua Logging Module
The plugin SHALL provide a Lua logging module that writes formatted log entries to the configured file.

#### Scenario: Log entry format
- **WHEN** a log entry is written
- **THEN** it includes timestamp in format `[YYYY-MM-DD HH:MM:SS.mmm]`
- **AND** it includes log level `[DEBUG|INFO|WARN|ERROR]`
- **AND** it includes source identifier `[lua:module]`
- **AND** it includes the log message

#### Scenario: Multi-line log entries
- **WHEN** logging content with newlines (e.g., code blocks)
- **THEN** subsequent lines are indented for readability
- **AND** the entry is clearly delimited

#### Scenario: File write errors
- **WHEN** the log file cannot be written
- **THEN** an error notification is shown to the user
- **AND** the plugin continues to function normally

### Requirement: TypeScript Logging Module
The plugin SHALL provide a TypeScript logging module that writes to the same log file as Lua.

#### Scenario: Configuration from environment
- **WHEN** the TypeScript service starts
- **THEN** it reads `NVIM_REDRAFT_DEBUG` environment variable
- **AND** it reads `NVIM_REDRAFT_LOG_FILE` environment variable
- **AND** debug logging is enabled if `NVIM_REDRAFT_DEBUG=1`

#### Scenario: Matching log format
- **WHEN** TypeScript writes a log entry
- **THEN** it uses the same timestamp format as Lua
- **AND** it uses source identifiers like `[ts:module]`
- **AND** it maintains consistent formatting with Lua logs

#### Scenario: Async file writes
- **WHEN** logging in TypeScript
- **THEN** file writes are performed asynchronously
- **AND** writes do not block request processing

### Requirement: Edit Operation Logging
The plugin SHALL log comprehensive information about edit operations when debug mode is enabled.

#### Scenario: Edit operation flow
- **WHEN** user triggers an edit operation
- **THEN** the following is logged in sequence:
  1. User instruction text
  2. Selected code (input)
  3. Visual selection details (line/col positions)
  4. System prompt used
  5. Request sent to TypeScript service
  6. Sparse edit generated by GPT-4o-mini
  7. Fast Apply request to MorphLLM
  8. Merged code result (output)
  9. Code replacement details
  10. Total operation time

#### Scenario: Successful edit logging
- **WHEN** an edit completes successfully
- **THEN** all intermediate steps are logged at DEBUG level
- **AND** completion is logged at INFO level
- **AND** timing information is included

#### Scenario: Failed edit logging
- **WHEN** an edit operation fails
- **THEN** the error is logged at ERROR level
- **AND** the error includes stack trace if available
- **AND** the failing step is clearly identified

### Requirement: IPC Communication Logging
The plugin SHALL log all JSON-RPC communication between Lua and TypeScript.

#### Scenario: Request logging
- **WHEN** Lua sends a JSON-RPC request
- **THEN** the request ID, method, and params are logged
- **AND** code params are included in full (subject to truncation limits)

#### Scenario: Response logging
- **WHEN** TypeScript sends a JSON-RPC response
- **THEN** the response ID and result/error are logged
- **AND** result code is included in full (subject to truncation limits)

#### Scenario: Service lifecycle logging
- **WHEN** the TypeScript service starts
- **THEN** initialization is logged with environment info
- **WHEN** the service exits
- **THEN** exit code and reason are logged

### Requirement: API Interaction Logging
The plugin SHALL log all interactions with external APIs (OpenAI, MorphLLM).

#### Scenario: API request logging
- **WHEN** making an API call
- **THEN** the model name is logged
- **AND** the request messages are logged
- **AND** API keys are redacted

#### Scenario: API response logging
- **WHEN** receiving an API response
- **THEN** the response content is logged
- **AND** response metadata is logged (tokens, timing)
- **AND** HTTP status code is logged

#### Scenario: API error logging
- **WHEN** an API call fails
- **THEN** the error message is logged
- **AND** HTTP status and error details are logged
- **AND** retry information is logged if applicable

### Requirement: Content Truncation
The plugin SHALL truncate large content in logs to prevent excessive file growth.

#### Scenario: Default truncation limit
- **WHEN** logging code or content exceeding 5000 characters
- **THEN** content is truncated at 5000 characters
- **AND** a truncation notice is appended: `... (truncated, X more chars)`

#### Scenario: Configurable truncation
- **WHEN** user sets `debug_max_log_size` in plugin setup
- **THEN** truncation uses the specified character limit
- **AND** setting it to `0` disables truncation

#### Scenario: Truncation markers
- **WHEN** content is truncated
- **THEN** the log clearly indicates how much was truncated
- **AND** users can identify which operations need higher limits

### Requirement: Log File Security
The plugin SHALL create log files with appropriate permissions to protect sensitive content.

#### Scenario: File permissions on Unix systems
- **WHEN** the log file is created
- **THEN** file permissions are set to `600` (owner read/write only)
- **AND** parent directories are created with `700` permissions

#### Scenario: Warning about sensitive content
- **WHEN** debug mode is first enabled
- **THEN** a notification warns that logs contain full code content
- **AND** the log file location is shown to the user

